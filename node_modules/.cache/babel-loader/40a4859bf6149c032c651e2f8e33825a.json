{"ast":null,"code":"const {\n  BN\n} = require(\"ethereumjs-util\");\n\nconst hexToBn = function () {\n  let val = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 0;\n  return new BN(parseInt(\"0x\" + val.toString(\"hex\"), 16));\n};\n\nconst MULTIPLE = 64 / 63;\n\nmodule.exports = async function binSearch(generateVM, runArgs, result, callback) {\n  const MAX = hexToBn(runArgs.block.header.gasLimit);\n  const gasRefund = result.execResult.gasRefund;\n  const startingGas = gasRefund ? result.gasEstimate.add(gasRefund) : result.gasEstimate;\n  const range = {\n    lo: startingGas,\n    hi: startingGas\n  };\n\n  const isEnoughGas = async gas => {\n    const vm = generateVM(); // Generate fresh VM\n\n    runArgs.tx.gasLimit = gas.toBuffer();\n    const result = await vm.runTx(runArgs).catch(vmerr => ({\n      vmerr\n    }));\n    return !result.vmerr && !result.execResult.exceptionError;\n  };\n\n  if (!(await isEnoughGas(range.hi))) {\n    do {\n      range.hi = range.hi.muln(MULTIPLE);\n    } while (!(await isEnoughGas(range.hi)));\n\n    while (range.lo.addn(1).lt(range.hi)) {\n      const mid = range.lo.add(range.hi).divn(2);\n\n      if (await isEnoughGas(mid)) {\n        range.hi = mid;\n      } else {\n        range.lo = mid;\n      }\n    }\n\n    if (range.hi.gte(MAX)) {\n      if (!(await isEnoughGas(range.hi))) {\n        return callback(new Error(\"gas required exceeds allowance or always failing transaction\"));\n      }\n    }\n  }\n\n  result.gasEstimate = range.hi;\n  callback(null, result);\n};","map":{"version":3,"names":["BN","require","hexToBn","val","parseInt","toString","MULTIPLE","module","exports","binSearch","generateVM","runArgs","result","callback","MAX","block","header","gasLimit","gasRefund","execResult","startingGas","gasEstimate","add","range","lo","hi","isEnoughGas","gas","vm","tx","toBuffer","runTx","catch","vmerr","exceptionError","muln","addn","lt","mid","divn","gte","Error"],"sources":["F:/Games/slotmachinereact/node_modules/ganache-core/lib/utils/gas/binSearch.js"],"sourcesContent":["const { BN } = require(\"ethereumjs-util\");\nconst hexToBn = (val = 0) => new BN(parseInt(\"0x\" + val.toString(\"hex\"), 16));\nconst MULTIPLE = 64 / 63;\n\nmodule.exports = async function binSearch(generateVM, runArgs, result, callback) {\n  const MAX = hexToBn(runArgs.block.header.gasLimit);\n  const gasRefund = result.execResult.gasRefund;\n  const startingGas = gasRefund ? result.gasEstimate.add(gasRefund) : result.gasEstimate;\n  const range = { lo: startingGas, hi: startingGas };\n  const isEnoughGas = async(gas) => {\n    const vm = generateVM(); // Generate fresh VM\n    runArgs.tx.gasLimit = gas.toBuffer();\n    const result = await vm.runTx(runArgs).catch((vmerr) => ({ vmerr }));\n    return !result.vmerr && !result.execResult.exceptionError;\n  };\n\n  if (!(await isEnoughGas(range.hi))) {\n    do {\n      range.hi = range.hi.muln(MULTIPLE);\n    } while (!(await isEnoughGas(range.hi)));\n    while (range.lo.addn(1).lt(range.hi)) {\n      const mid = range.lo.add(range.hi).divn(2);\n      if (await isEnoughGas(mid)) {\n        range.hi = mid;\n      } else {\n        range.lo = mid;\n      }\n    }\n    if (range.hi.gte(MAX)) {\n      if (!(await isEnoughGas(range.hi))) {\n        return callback(new Error(\"gas required exceeds allowance or always failing transaction\"));\n      }\n    }\n  }\n\n  result.gasEstimate = range.hi;\n  callback(null, result);\n};\n"],"mappings":"AAAA,MAAM;EAAEA;AAAF,IAASC,OAAO,CAAC,iBAAD,CAAtB;;AACA,MAAMC,OAAO,GAAG;EAAA,IAACC,GAAD,uEAAO,CAAP;EAAA,OAAa,IAAIH,EAAJ,CAAOI,QAAQ,CAAC,OAAOD,GAAG,CAACE,QAAJ,CAAa,KAAb,CAAR,EAA6B,EAA7B,CAAf,CAAb;AAAA,CAAhB;;AACA,MAAMC,QAAQ,GAAG,KAAK,EAAtB;;AAEAC,MAAM,CAACC,OAAP,GAAiB,eAAeC,SAAf,CAAyBC,UAAzB,EAAqCC,OAArC,EAA8CC,MAA9C,EAAsDC,QAAtD,EAAgE;EAC/E,MAAMC,GAAG,GAAGZ,OAAO,CAACS,OAAO,CAACI,KAAR,CAAcC,MAAd,CAAqBC,QAAtB,CAAnB;EACA,MAAMC,SAAS,GAAGN,MAAM,CAACO,UAAP,CAAkBD,SAApC;EACA,MAAME,WAAW,GAAGF,SAAS,GAAGN,MAAM,CAACS,WAAP,CAAmBC,GAAnB,CAAuBJ,SAAvB,CAAH,GAAuCN,MAAM,CAACS,WAA3E;EACA,MAAME,KAAK,GAAG;IAAEC,EAAE,EAAEJ,WAAN;IAAmBK,EAAE,EAAEL;EAAvB,CAAd;;EACA,MAAMM,WAAW,GAAG,MAAMC,GAAN,IAAc;IAChC,MAAMC,EAAE,GAAGlB,UAAU,EAArB,CADgC,CACP;;IACzBC,OAAO,CAACkB,EAAR,CAAWZ,QAAX,GAAsBU,GAAG,CAACG,QAAJ,EAAtB;IACA,MAAMlB,MAAM,GAAG,MAAMgB,EAAE,CAACG,KAAH,CAASpB,OAAT,EAAkBqB,KAAlB,CAAyBC,KAAD,KAAY;MAAEA;IAAF,CAAZ,CAAxB,CAArB;IACA,OAAO,CAACrB,MAAM,CAACqB,KAAR,IAAiB,CAACrB,MAAM,CAACO,UAAP,CAAkBe,cAA3C;EACD,CALD;;EAOA,IAAI,EAAE,MAAMR,WAAW,CAACH,KAAK,CAACE,EAAP,CAAnB,CAAJ,EAAoC;IAClC,GAAG;MACDF,KAAK,CAACE,EAAN,GAAWF,KAAK,CAACE,EAAN,CAASU,IAAT,CAAc7B,QAAd,CAAX;IACD,CAFD,QAES,EAAE,MAAMoB,WAAW,CAACH,KAAK,CAACE,EAAP,CAAnB,CAFT;;IAGA,OAAOF,KAAK,CAACC,EAAN,CAASY,IAAT,CAAc,CAAd,EAAiBC,EAAjB,CAAoBd,KAAK,CAACE,EAA1B,CAAP,EAAsC;MACpC,MAAMa,GAAG,GAAGf,KAAK,CAACC,EAAN,CAASF,GAAT,CAAaC,KAAK,CAACE,EAAnB,EAAuBc,IAAvB,CAA4B,CAA5B,CAAZ;;MACA,IAAI,MAAMb,WAAW,CAACY,GAAD,CAArB,EAA4B;QAC1Bf,KAAK,CAACE,EAAN,GAAWa,GAAX;MACD,CAFD,MAEO;QACLf,KAAK,CAACC,EAAN,GAAWc,GAAX;MACD;IACF;;IACD,IAAIf,KAAK,CAACE,EAAN,CAASe,GAAT,CAAa1B,GAAb,CAAJ,EAAuB;MACrB,IAAI,EAAE,MAAMY,WAAW,CAACH,KAAK,CAACE,EAAP,CAAnB,CAAJ,EAAoC;QAClC,OAAOZ,QAAQ,CAAC,IAAI4B,KAAJ,CAAU,8DAAV,CAAD,CAAf;MACD;IACF;EACF;;EAED7B,MAAM,CAACS,WAAP,GAAqBE,KAAK,CAACE,EAA3B;EACAZ,QAAQ,CAAC,IAAD,EAAOD,MAAP,CAAR;AACD,CAjCD"},"metadata":{},"sourceType":"script"}