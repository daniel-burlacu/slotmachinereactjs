{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar async = require(\"async\");\n\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\n\nvar ethereumjs_common_1 = require(\"ethereumjs-common\");\n\nvar callbackify_1 = require(\"./callbackify\");\n\nvar dbManager_1 = require(\"./dbManager\");\n\nvar util_1 = require(\"./util\");\n\nvar Block = require('ethereumjs-block');\n\nvar Ethash = require('ethashjs');\n\nvar Stoplight = require('flow-stoplight');\n\nvar level = require('level-mem');\n\nvar semaphore = require('semaphore');\n/**\n * This class stores and interacts with blocks.\n */\n\n\nvar Blockchain =\n/** @class */\nfunction () {\n  /**\n   * Creates new Blockchain object\n   *\n   * @param opts - An object with the options that this constructor takes. See [[BlockchainOptions]].\n   */\n  function Blockchain(opts) {\n    var _this = this;\n\n    if (opts === void 0) {\n      opts = {};\n    }\n    /**\n     * This field is always `true`. It's here only for backwards compatibility.\n     *\n     * @deprecated\n     */\n\n\n    this.validate = true;\n\n    if (opts.common) {\n      if (opts.chain) {\n        throw new Error('Instantiation with both opts.common and opts.chain parameter not allowed!');\n      }\n\n      this._common = opts.common;\n    } else {\n      var chain = opts.chain ? opts.chain : 'mainnet';\n      var hardfork = opts.hardfork ? opts.hardfork : null;\n      this._common = new ethereumjs_common_1.default(chain, hardfork);\n    }\n\n    if (opts.validate !== undefined) {\n      if (opts.validatePow !== undefined || opts.validateBlocks !== undefined) {\n        throw new Error(\"opts.validate can't be used at the same time than opts.validatePow nor opts.validateBlocks\");\n      }\n    } // defaults\n\n\n    if (opts.validate !== undefined) {\n      this._validatePow = opts.validate;\n      this._validateBlocks = opts.validate;\n    } else {\n      this._validatePow = opts.validatePow !== undefined ? opts.validatePow : true;\n      this._validateBlocks = opts.validateBlocks !== undefined ? opts.validateBlocks : true;\n    }\n\n    this.db = opts.db ? opts.db : level();\n    this.dbManager = new dbManager_1.default(this.db, this._common);\n    this.ethash = this._validatePow ? new Ethash(this.db) : null;\n    this._heads = {};\n    this._genesis = null;\n    this._headHeader = null;\n    this._headBlock = null;\n    this._initDone = false;\n    this._putSemaphore = semaphore(1);\n    this._initLock = new Stoplight();\n\n    this._init(function (err) {\n      if (err) {\n        throw err;\n      }\n\n      _this._initLock.go();\n    });\n  }\n\n  Object.defineProperty(Blockchain.prototype, \"meta\", {\n    /**\n     * Returns an object with metadata about the Blockchain. It's defined for backwards compatibility.\n     */\n    get: function () {\n      return {\n        rawHead: this._headHeader,\n        heads: this._heads,\n        genesis: this._genesis\n      };\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Fetches the meta info about the blockchain from the db. Meta info contains\n   * hashes of the headerchain head, blockchain head, genesis block and iterator\n   * heads.\n   *\n   * @hidden\n   */\n\n  Blockchain.prototype._init = function (cb) {\n    var self = this;\n    async.waterfall([function (cb) {\n      return self._numberToHash(new ethereumjs_util_1.BN(0), cb);\n    }, callbackify_1.callbackify(getHeads.bind(this))], function (err) {\n      if (err) {\n        // if genesis block doesn't exist, create one\n        return self._setCanonicalGenesisBlock(function (err) {\n          if (err) {\n            return cb(err);\n          }\n\n          self._heads = {};\n          self._headHeader = self._genesis;\n          self._headBlock = self._genesis;\n          cb();\n        });\n      }\n\n      cb();\n    });\n\n    function getHeads(genesisHash) {\n      return __awaiter(this, void 0, void 0, function () {\n        var heads_1, e_1, hash, e_2, e_3;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              self._genesis = genesisHash;\n              _a.label = 1;\n\n            case 1:\n              _a.trys.push([1, 3,, 4]);\n\n              return [4\n              /*yield*/\n              , self.dbManager.getHeads()];\n\n            case 2:\n              heads_1 = _a.sent();\n              Object.keys(heads_1).forEach(function (key) {\n                heads_1[key] = Buffer.from(heads_1[key]);\n              });\n              self._heads = heads_1;\n              return [3\n              /*break*/\n              , 4];\n\n            case 3:\n              e_1 = _a.sent();\n              self._heads = {};\n              return [3\n              /*break*/\n              , 4];\n\n            case 4:\n              _a.trys.push([4, 6,, 7]);\n\n              return [4\n              /*yield*/\n              , self.dbManager.getHeadHeader()];\n\n            case 5:\n              hash = _a.sent();\n              self._headHeader = hash;\n              return [3\n              /*break*/\n              , 7];\n\n            case 6:\n              e_2 = _a.sent();\n              self._headHeader = genesisHash;\n              return [3\n              /*break*/\n              , 7];\n\n            case 7:\n              _a.trys.push([7, 9,, 10]);\n\n              return [4\n              /*yield*/\n              , self.dbManager.getHeadBlock()];\n\n            case 8:\n              hash = _a.sent();\n              self._headBlock = hash;\n              return [3\n              /*break*/\n              , 10];\n\n            case 9:\n              e_3 = _a.sent();\n              self._headBlock = genesisHash;\n              return [3\n              /*break*/\n              , 10];\n\n            case 10:\n              return [2\n              /*return*/\n              ];\n          }\n        });\n      });\n    }\n  };\n  /**\n   * Sets the default genesis block\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._setCanonicalGenesisBlock = function (cb) {\n    var genesisBlock = new Block(null, {\n      common: this._common\n    });\n    genesisBlock.setGenesisParams();\n\n    this._putBlockOrHeader(genesisBlock, cb, true);\n  };\n  /**\n   * Puts the genesis block in the database\n   *\n   * @param genesis - The genesis block to be added\n   * @param cb - The callback. It is given two parameters `err` and the saved `block`\n   */\n\n\n  Blockchain.prototype.putGenesis = function (genesis, cb) {\n    this.putBlock(genesis, cb, true);\n  };\n  /**\n   * Returns the specified iterator head.\n   *\n   * @param name - Optional name of the state root head (default: 'vm')\n   * @param cb - The callback. It is given two parameters `err` and the returned `block`\n   */\n\n\n  Blockchain.prototype.getHead = function (name, cb) {\n    var _this = this; // handle optional args\n\n\n    if (typeof name === 'function') {\n      cb = name;\n      name = 'vm';\n    } // ensure init completed\n\n\n    this._initLock.await(function () {\n      // if the head is not found return the headHeader\n      var hash = _this._heads[name] || _this._headBlock;\n\n      if (!hash) {\n        return cb(new Error('No head found.'));\n      }\n\n      _this.getBlock(hash, cb);\n    });\n  };\n  /**\n   * Returns the latest header in the canonical chain.\n   *\n   * @param cb - The callback. It is given two parameters `err` and the returned `header`\n   */\n\n\n  Blockchain.prototype.getLatestHeader = function (cb) {\n    var _this = this; // ensure init completed\n\n\n    this._initLock.await(function () {\n      _this.getBlock(_this._headHeader, function (err, block) {\n        if (err) {\n          return cb(err);\n        }\n\n        cb(null, block.header);\n      });\n    });\n  };\n  /**\n   * Returns the latest full block in the canonical chain.\n   *\n   * @param cb - The callback. It is given two parameters `err` and the returned `block`\n   */\n\n\n  Blockchain.prototype.getLatestBlock = function (cb) {\n    var _this = this; // ensure init completed\n\n\n    this._initLock.await(function () {\n      _this.getBlock(_this._headBlock, cb);\n    });\n  };\n  /**\n   * Adds many blocks to the blockchain.\n   *\n   * @param blocks - The blocks to be added to the blockchain\n   * @param cb - The callback. It is given two parameters `err` and the last of the saved `blocks`\n   */\n\n\n  Blockchain.prototype.putBlocks = function (blocks, cb) {\n    var _this = this;\n\n    async.eachSeries(blocks, function (block, done) {\n      _this.putBlock(block, done);\n    }, cb);\n  };\n  /**\n   * Adds a block to the blockchain.\n   *\n   * @param block - The block to be added to the blockchain\n   * @param cb - The callback. It is given two parameters `err` and the saved `block`\n   */\n\n\n  Blockchain.prototype.putBlock = function (block, cb, isGenesis) {\n    var _this = this; // make sure init has completed\n\n\n    this._initLock.await(function () {\n      // perform put with mutex dance\n      _this._lockUnlock(function (done) {\n        _this._putBlockOrHeader(block, done, isGenesis);\n      }, cb);\n    });\n  };\n  /**\n   * Adds many headers to the blockchain.\n   *\n   * @param headers - The headers to be added to the blockchain\n   * @param cb - The callback. It is given two parameters `err` and the last of the saved `headers`\n   */\n\n\n  Blockchain.prototype.putHeaders = function (headers, cb) {\n    var _this = this;\n\n    async.eachSeries(headers, function (header, done) {\n      _this.putHeader(header, done);\n    }, cb);\n  };\n  /**\n   * Adds a header to the blockchain.\n   *\n   * @param header - The header to be added to the blockchain\n   * @param cb - The callback. It is given two parameters `err` and the saved `header`\n   */\n\n\n  Blockchain.prototype.putHeader = function (header, cb) {\n    var _this = this; // make sure init has completed\n\n\n    this._initLock.await(function () {\n      // perform put with mutex dance\n      _this._lockUnlock(function (done) {\n        _this._putBlockOrHeader(header, done);\n      }, cb);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._putBlockOrHeader = function (item, cb, isGenesis) {\n    var self = this;\n    var isHeader = item instanceof Block.Header;\n    var block = isHeader ? new Block([item.raw, [], []], {\n      common: item._common\n    }) : item;\n    var header = block.header;\n    var hash = block.hash();\n    var number = new ethereumjs_util_1.BN(header.number);\n    var td = new ethereumjs_util_1.BN(header.difficulty);\n    var currentTd = {\n      header: null,\n      block: null\n    };\n    var dbOps = [];\n\n    if (block.constructor !== Block) {\n      block = new Block(block, {\n        common: self._common\n      });\n    }\n\n    if (block._common.chainId() !== self._common.chainId()) {\n      return cb(new Error('Chain mismatch while trying to put block or header'));\n    }\n\n    async.series([verify, verifyPOW, getCurrentTd, getBlockTd, rebuildInfo, function (cb) {\n      return self._batchDbOps(dbOps.concat(self._saveHeadOps()), cb);\n    }], cb);\n\n    function verify(next) {\n      if (!self._validateBlocks) {\n        return next();\n      }\n\n      if (!isGenesis && block.isGenesis()) {\n        return next(new Error('already have genesis set'));\n      }\n\n      block.validate(self, next);\n    }\n\n    function verifyPOW(next) {\n      if (!self._validatePow) {\n        return next();\n      }\n\n      self.ethash.verifyPOW(block, function (valid) {\n        next(valid ? null : new Error('invalid POW'));\n      });\n    }\n\n    function getCurrentTd(next) {\n      if (isGenesis) {\n        currentTd.header = new ethereumjs_util_1.BN(0);\n        currentTd.block = new ethereumjs_util_1.BN(0);\n        return next();\n      }\n\n      async.parallel([function (cb) {\n        return self._getTd(self._headHeader, function (err, td) {\n          currentTd.header = td;\n          cb(err);\n        });\n      }, function (cb) {\n        return self._getTd(self._headBlock, function (err, td) {\n          currentTd.block = td;\n          cb(err);\n        });\n      }], next);\n    }\n\n    function getBlockTd(next) {\n      // calculate the total difficulty of the new block\n      if (isGenesis) {\n        return next();\n      }\n\n      self._getTd(header.parentHash, number.subn(1), function (err, parentTd) {\n        if (err) {\n          return next(err);\n        }\n\n        td.iadd(parentTd);\n        next();\n      });\n    }\n\n    function rebuildInfo(next) {\n      // save block and total difficulty to the database\n      var key = util_1.tdKey(number, hash);\n      var value = ethereumjs_util_1.rlp.encode(td);\n      dbOps.push({\n        type: 'put',\n        key: key,\n        keyEncoding: 'binary',\n        valueEncoding: 'binary',\n        value: value\n      });\n\n      self.dbManager._cache.td.set(key, value); // save header\n\n\n      key = util_1.headerKey(number, hash);\n      value = ethereumjs_util_1.rlp.encode(header.raw);\n      dbOps.push({\n        type: 'put',\n        key: key,\n        keyEncoding: 'binary',\n        valueEncoding: 'binary',\n        value: value\n      });\n\n      self.dbManager._cache.header.set(key, value); // store body if it exists\n\n\n      if (isGenesis || block.transactions.length || block.uncleHeaders.length) {\n        var body = block.serialize(false).slice(1);\n        key = util_1.bodyKey(number, hash);\n        value = ethereumjs_util_1.rlp.encode(body);\n        dbOps.push({\n          type: 'put',\n          key: key,\n          keyEncoding: 'binary',\n          valueEncoding: 'binary',\n          value: value\n        });\n\n        self.dbManager._cache.body.set(key, value);\n      } // if total difficulty is higher than current, add it to canonical chain\n\n\n      if (block.isGenesis() || td.gt(currentTd.header)) {\n        self._headHeader = hash;\n\n        if (!isHeader) {\n          self._headBlock = hash;\n        }\n\n        if (block.isGenesis()) {\n          self._genesis = hash;\n        } // delete higher number assignments and overwrite stale canonical chain\n\n\n        async.parallel([function (cb) {\n          return self._deleteStaleAssignments(number.addn(1), hash, dbOps, cb);\n        }, function (cb) {\n          return self._rebuildCanonical(header, dbOps, cb);\n        }], next);\n      } else {\n        if (td.gt(currentTd.block) && !isHeader) {\n          self._headBlock = hash;\n        } // save hash to number lookup info even if rebuild not needed\n\n\n        key = util_1.hashToNumberKey(hash);\n        value = util_1.bufBE8(number);\n        dbOps.push({\n          type: 'put',\n          key: key,\n          keyEncoding: 'binary',\n          valueEncoding: 'binary',\n          value: value\n        });\n\n        self.dbManager._cache.hashToNumber.set(key, value);\n\n        next();\n      }\n    }\n  };\n  /**\n   * Gets a block by its hash.\n   *\n   * @param blockTag - The block's hash or number\n   * @param cb - The callback. It is given two parameters `err` and the found `block` (an instance of https://github.com/ethereumjs/ethereumjs-block) if any.\n   */\n\n\n  Blockchain.prototype.getBlock = function (blockTag, cb) {\n    var _this = this; // ensure init completed\n\n\n    this._initLock.await(function () {\n      _this._getBlock(blockTag, cb);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._getBlock = function (blockTag, cb) {\n    callbackify_1.callbackify(this.dbManager.getBlock.bind(this.dbManager))(blockTag, cb);\n  };\n  /**\n   * Looks up many blocks relative to blockId\n   *\n   * @param blockId - The block's hash or number\n   * @param maxBlocks - Max number of blocks to return\n   * @param skip - Number of blocks to skip apart\n   * @param reverse - Fetch blocks in reverse\n   * @param cb - The callback. It is given two parameters `err` and the found `blocks` if any.\n   */\n\n\n  Blockchain.prototype.getBlocks = function (blockId, maxBlocks, skip, reverse, cb) {\n    var self = this;\n    var blocks = [];\n    var i = -1;\n\n    function nextBlock(blockId) {\n      self.getBlock(blockId, function (err, block) {\n        i++;\n\n        if (err) {\n          if (err.notFound) {\n            return cb(null, blocks);\n          } else {\n            return cb(err);\n          }\n        }\n\n        var nextBlockNumber = new ethereumjs_util_1.BN(block.header.number).addn(reverse ? -1 : 1);\n\n        if (i !== 0 && skip && i % (skip + 1) !== 0) {\n          return nextBlock(nextBlockNumber);\n        }\n\n        blocks.push(block);\n\n        if (blocks.length === maxBlocks) {\n          return cb(null, blocks);\n        }\n\n        nextBlock(nextBlockNumber);\n      });\n    }\n\n    nextBlock(blockId);\n  };\n  /**\n   * This method used to return block details by its hash. It's only here for backwards compatibility.\n   *\n   * @deprecated\n   */\n\n\n  Blockchain.prototype.getDetails = function (_, cb) {\n    cb(null, {});\n  };\n  /**\n   * Given an ordered array, returns to the callback an array of hashes that are not in the blockchain yet.\n   *\n   * @param hashes - Ordered array of hashes\n   * @param cb - The callback. It is given two parameters `err` and hashes found.\n   */\n\n\n  Blockchain.prototype.selectNeededHashes = function (hashes, cb) {\n    var self = this;\n    var max, mid, min;\n    max = hashes.length - 1;\n    mid = min = 0;\n    async.whilst(function test() {\n      return max >= min;\n    }, function iterate(cb2) {\n      self._hashToNumber(hashes[mid], function (err, number) {\n        if (!err && number) {\n          min = mid + 1;\n        } else {\n          max = mid - 1;\n        }\n\n        mid = Math.floor((min + max) / 2);\n        cb2();\n      });\n    }, function onDone(err) {\n      if (err) return cb(err);\n      cb(null, hashes.slice(min));\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._saveHeadOps = function () {\n    return [{\n      type: 'put',\n      key: 'heads',\n      keyEncoding: 'binary',\n      valueEncoding: 'json',\n      value: this._heads\n    }, {\n      type: 'put',\n      key: util_1.headHeaderKey,\n      keyEncoding: 'binary',\n      valueEncoding: 'binary',\n      value: this._headHeader\n    }, {\n      type: 'put',\n      key: util_1.headBlockKey,\n      keyEncoding: 'binary',\n      valueEncoding: 'binary',\n      value: this._headBlock\n    }];\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._saveHeads = function (cb) {\n    this._batchDbOps(this._saveHeadOps(), cb);\n  };\n  /**\n   * Delete canonical number assignments for specified number and above\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._deleteStaleAssignments = function (number, headHash, ops, cb) {\n    var _this = this;\n\n    var key = util_1.numberToHashKey(number);\n\n    this._numberToHash(number, function (err, hash) {\n      if (err) {\n        return cb();\n      }\n\n      ops.push({\n        type: 'del',\n        key: key,\n        keyEncoding: 'binary'\n      });\n\n      _this.dbManager._cache.numberToHash.del(key); // reset stale iterator heads to current canonical head\n\n\n      Object.keys(_this._heads).forEach(function (name) {\n        if (_this._heads[name].equals(hash)) {\n          _this._heads[name] = headHash;\n        }\n      }); // reset stale headBlock to current canonical\n\n      if (_this._headBlock.equals(hash)) {\n        _this._headBlock = headHash;\n      }\n\n      _this._deleteStaleAssignments(number.addn(1), headHash, ops, cb);\n    });\n  };\n  /**\n   * Overwrites stale canonical number assignments.\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._rebuildCanonical = function (header, ops, cb) {\n    var self = this;\n    var hash = header.hash();\n    var number = new ethereumjs_util_1.BN(header.number);\n\n    function saveLookups(hash, number) {\n      var key = util_1.numberToHashKey(number);\n      var value;\n      ops.push({\n        type: 'put',\n        key: key,\n        keyEncoding: 'binary',\n        valueEncoding: 'binary',\n        value: hash\n      });\n\n      self.dbManager._cache.numberToHash.set(key, hash);\n\n      key = util_1.hashToNumberKey(hash);\n      value = util_1.bufBE8(number);\n      ops.push({\n        type: 'put',\n        key: key,\n        keyEncoding: 'binary',\n        valueEncoding: 'binary',\n        value: value\n      });\n\n      self.dbManager._cache.hashToNumber.set(key, value);\n    } // handle genesis block\n\n\n    if (number.cmpn(0) === 0) {\n      saveLookups(hash, number);\n      return cb();\n    }\n\n    self._numberToHash(number, function (err, staleHash) {\n      if (err) {\n        staleHash = null;\n      }\n\n      if (!staleHash || !hash.equals(staleHash)) {\n        saveLookups(hash, number); // flag stale head for reset\n\n        Object.keys(self._heads).forEach(function (name) {\n          if (staleHash && self._heads[name].equals(staleHash)) {\n            self._staleHeads = self._staleHeads || [];\n\n            self._staleHeads.push(name);\n          }\n        }); // flag stale headBlock for reset\n\n        if (staleHash && self._headBlock.equals(staleHash)) {\n          self._staleHeadBlock = true;\n        }\n\n        self._getHeader(header.parentHash, number.subn(1), function (err, header) {\n          if (err) {\n            delete self._staleHeads;\n            return cb(err);\n          }\n\n          self._rebuildCanonical(header, ops, cb);\n        });\n      } else {\n        // set stale heads to last previously valid canonical block\n        ;\n        (self._staleHeads || []).forEach(function (name) {\n          self._heads[name] = hash;\n        });\n        delete self._staleHeads; // set stale headBlock to last previously valid canonical block\n\n        if (self._staleHeadBlock) {\n          self._headBlock = hash;\n          delete self._staleHeadBlock;\n        }\n\n        cb();\n      }\n    });\n  };\n  /**\n   * Deletes a block from the blockchain. All child blocks in the chain are deleted and any\n   * encountered heads are set to the parent block.\n   *\n   * @param blockHash - The hash of the block to be deleted\n   * @param cb - A callback.\n   */\n\n\n  Blockchain.prototype.delBlock = function (blockHash, cb) {\n    var _this = this; // make sure init has completed\n\n\n    this._initLock.await(function () {\n      // perform put with mutex dance\n      _this._lockUnlock(function (done) {\n        _this._delBlock(blockHash, done);\n      }, cb);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._delBlock = function (blockHash, cb) {\n    var self = this;\n    var dbOps = [];\n    var blockHeader = null;\n    var blockNumber = null;\n    var parentHash = null;\n    var inCanonical = null;\n\n    if (!Buffer.isBuffer(blockHash)) {\n      blockHash = blockHash.hash();\n    }\n\n    async.series([getHeader, checkCanonical, buildDBops, deleteStaleAssignments, function (cb) {\n      return self._batchDbOps(dbOps, cb);\n    }], cb);\n\n    function getHeader(cb2) {\n      self._getHeader(blockHash, function (err, header) {\n        if (err) return cb2(err);\n        blockHeader = header;\n        blockNumber = new ethereumjs_util_1.BN(blockHeader.number);\n        parentHash = blockHeader.parentHash;\n        cb2();\n      });\n    } // check if block is in the canonical chain\n\n\n    function checkCanonical(cb2) {\n      self._numberToHash(blockNumber, function (err, hash) {\n        inCanonical = !err && hash.equals(blockHash);\n        cb2();\n      });\n    } // delete the block, and if block is in the canonical chain, delete all\n    // children as well\n\n\n    function buildDBops(cb2) {\n      self._delChild(blockHash, blockNumber, inCanonical ? parentHash : null, dbOps, cb2);\n    } // delete all number to hash mappings for deleted block number and above\n\n\n    function deleteStaleAssignments(cb2) {\n      if (inCanonical) {\n        self._deleteStaleAssignments(blockNumber, parentHash, dbOps, cb2);\n      } else {\n        cb2();\n      }\n    }\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._delChild = function (hash, number, headHash, ops, cb) {\n    var self = this; // delete header, body, hash to number mapping and td\n\n    ops.push({\n      type: 'del',\n      key: util_1.headerKey(number, hash),\n      keyEncoding: 'binary'\n    });\n\n    self.dbManager._cache.header.del(util_1.headerKey(number, hash));\n\n    ops.push({\n      type: 'del',\n      key: util_1.bodyKey(number, hash),\n      keyEncoding: 'binary'\n    });\n\n    self.dbManager._cache.body.del(util_1.bodyKey(number, hash));\n\n    ops.push({\n      type: 'del',\n      key: util_1.hashToNumberKey(hash),\n      keyEncoding: 'binary'\n    });\n\n    self.dbManager._cache.hashToNumber.del(util_1.hashToNumberKey(hash));\n\n    ops.push({\n      type: 'del',\n      key: util_1.tdKey(number, hash),\n      keyEncoding: 'binary'\n    });\n\n    self.dbManager._cache.td.del(util_1.tdKey(number, hash));\n\n    if (!headHash) {\n      return cb();\n    }\n\n    if (hash.equals(self._headHeader)) {\n      self._headHeader = headHash;\n    }\n\n    if (hash.equals(self._headBlock)) {\n      self._headBlock = headHash;\n    }\n\n    self._getCanonicalHeader(number.addn(1), function (err, childHeader) {\n      if (err) {\n        return cb();\n      }\n\n      self._delChild(childHeader.hash(), new ethereumjs_util_1.BN(childHeader.number), headHash, ops, cb);\n    });\n  };\n  /**\n   * Iterates through blocks starting at the specified iterator head and calls the onBlock function\n   * on each block. The current location of an iterator head can be retrieved using the `getHead()`\n   * method.\n   *\n   * @param name - Name of the state root head\n   * @param onBlock - Function called on each block with params (block, reorg, cb)\n   * @param cb - A callback function\n   */\n\n\n  Blockchain.prototype.iterator = function (name, onBlock, cb) {\n    var _this = this; // ensure init completed\n\n\n    this._initLock.await(function () {\n      _this._iterator(name, onBlock, cb);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._iterator = function (name, func, cb) {\n    var self = this;\n    var blockHash = self._heads[name] || self._genesis;\n    var blockNumber;\n    var lastBlock;\n\n    if (!blockHash) {\n      return cb();\n    }\n\n    self._hashToNumber(blockHash, function (err, number) {\n      if (err) return cb(err);\n      blockNumber = number.addn(1);\n      async.whilst(function () {\n        return blockNumber;\n      }, run, function (err) {\n        return err ? cb(err) : self._saveHeads(cb);\n      });\n    });\n\n    function run(cb2) {\n      var block;\n      async.series([getBlock, runFunc], function (err) {\n        if (!err) {\n          blockNumber.iaddn(1);\n        } else {\n          blockNumber = false; // No more blocks, return\n\n          if (err.type === 'NotFoundError') {\n            return cb2();\n          }\n        }\n\n        cb2(err);\n      });\n\n      function getBlock(cb3) {\n        self.getBlock(blockNumber, function (err, b) {\n          block = b;\n\n          if (block) {\n            self._heads[name] = block.hash();\n          }\n\n          cb3(err);\n        });\n      }\n\n      function runFunc(cb3) {\n        var reorg = lastBlock ? lastBlock.hash().equals(block.header.parentHash) : false;\n        lastBlock = block;\n        func(block, reorg, cb3);\n      }\n    }\n  };\n  /**\n   * Executes multiple db operations in a single batch call\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._batchDbOps = function (dbOps, cb) {\n    callbackify_1.callbackify(this.dbManager.batch.bind(this.dbManager))(dbOps, cb);\n  };\n  /**\n   * Performs a block hash to block number lookup\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._hashToNumber = function (hash, cb) {\n    callbackify_1.callbackify(this.dbManager.hashToNumber.bind(this.dbManager))(hash, cb);\n  };\n  /**\n   * Performs a block number to block hash lookup\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._numberToHash = function (number, cb) {\n    callbackify_1.callbackify(this.dbManager.numberToHash.bind(this.dbManager))(number, cb);\n  };\n  /**\n   * Helper function to lookup a block by either hash only or a hash and number\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._lookupByHashNumber = function (hash, number, cb, next) {\n    if (typeof number === 'function') {\n      cb = number;\n      return this._hashToNumber(hash, function (err, number) {\n        if (err) {\n          return next(err, hash, null, cb);\n        }\n\n        next(null, hash, number, cb);\n      });\n    }\n\n    next(null, hash, number, cb);\n  };\n  /**\n   * Gets a header by hash and number. Header can exist outside the canonical chain\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._getHeader = function (hash, number, cb) {\n    var _this = this;\n\n    this._lookupByHashNumber(hash, number, cb, function (err, hash, number, cb) {\n      if (err) {\n        return cb(err);\n      }\n\n      callbackify_1.callbackify(_this.dbManager.getHeader.bind(_this.dbManager))(hash, number, cb);\n    });\n  };\n  /**\n   * Gets a header by number. Header must be in the canonical chain\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._getCanonicalHeader = function (number, cb) {\n    var _this = this;\n\n    this._numberToHash(number, function (err, hash) {\n      if (err) {\n        return cb(err);\n      }\n\n      _this._getHeader(hash, number, cb);\n    });\n  };\n  /**\n   * Gets total difficulty for a block specified by hash and number\n   *\n   * @hidden\n   */\n\n\n  Blockchain.prototype._getTd = function (hash, number, cb) {\n    var _this = this;\n\n    this._lookupByHashNumber(hash, number, cb, function (err, hash, number, cb) {\n      if (err) {\n        return cb(err);\n      }\n\n      callbackify_1.callbackify(_this.dbManager.getTd.bind(_this.dbManager))(hash, number, cb);\n    });\n  };\n  /**\n   * @hidden\n   */\n\n\n  Blockchain.prototype._lockUnlock = function (fn, cb) {\n    var self = this;\n\n    this._putSemaphore.take(function () {\n      fn(after);\n\n      function after() {\n        self._putSemaphore.leave();\n\n        cb.apply(null, arguments);\n      }\n    });\n  };\n\n  return Blockchain;\n}();\n\nexports.default = Blockchain;","map":{"version":3,"mappings":"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","names":["Block","require","Ethash","Stoplight","level","semaphore","opts","common","chain","Error","_common","hardfork","ethereumjs_common_1","validate","undefined","validatePow","validateBlocks","_validatePow","_validateBlocks","db","dbManager","dbManager_1","ethash","_heads","_genesis","_headHeader","_headBlock","_initDone","_putSemaphore","_initLock","_init","err","_this","go","Object","Blockchain","rawHead","heads","genesis","cb","self","async","waterfall","_numberToHash","ethereumjs_util_1","callbackify_1","getHeads","bind","_setCanonicalGenesisBlock","genesisHash","heads_1","_a","keys","forEach","key","Buffer","from","getHeadHeader","hash","getHeadBlock","genesisBlock","setGenesisParams","_putBlockOrHeader","putBlock","name","await","getBlock","block","header","blocks","eachSeries","done","isGenesis","_lockUnlock","headers","putHeader","item","isHeader","Header","raw","number","td","difficulty","currentTd","dbOps","constructor","chainId","series","verify","verifyPOW","getCurrentTd","getBlockTd","rebuildInfo","_batchDbOps","concat","_saveHeadOps","next","valid","parallel","_getTd","parentHash","subn","parentTd","iadd","util_1","value","encode","push","type","keyEncoding","valueEncoding","_cache","set","transactions","length","uncleHeaders","body","serialize","slice","gt","_deleteStaleAssignments","addn","_rebuildCanonical","hashToNumber","blockTag","_getBlock","blockId","maxBlocks","skip","reverse","i","nextBlock","notFound","nextBlockNumber","_","hashes","max","mid","min","whilst","test","iterate","cb2","_hashToNumber","Math","floor","onDone","headHash","ops","numberToHash","del","equals","saveLookups","cmpn","staleHash","_staleHeads","_staleHeadBlock","_getHeader","blockHash","_delBlock","blockHeader","blockNumber","inCanonical","isBuffer","getHeader","checkCanonical","buildDBops","deleteStaleAssignments","_delChild","_getCanonicalHeader","childHeader","onBlock","_iterator","func","lastBlock","run","_saveHeads","runFunc","iaddn","cb3","b","reorg","batch","_lookupByHashNumber","getTd","fn","take","after","leave","apply","arguments"],"sources":["../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}